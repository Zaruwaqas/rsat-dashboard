<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSAT Dashboard HP</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      background: #1a1e24;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .chroma-container {
      background: #222831;
      border-radius: 32px;
      padding: 30px;
      box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.8);
      border: 1px solid #2d343d;
      max-width: 1800px;
      margin: 0 auto;
    }

    h3, .card-title, .filter-label, .kpi-label {
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    .card-chart { 
      background: #2a303a;
      border-radius: 24px; 
      padding: 1.5rem; 
      box-shadow: 0 15px 30px -12px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px; 
      height: 100%;
      transition: all 0.3s ease;
      border: 1px solid #363f4a;
    }

    .card-chart:hover {
      transform: translateY(-2px);
      border-color: #5f6b7a;
    }

    .card-title { 
      font-size: 1.1rem; 
      font-weight: 500; 
      color: #ffffff;
      margin-bottom: 20px; 
      padding-bottom: 12px; 
      border-bottom: 1px solid #363f4a; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-title span { 
      font-size: 0.75rem; 
      font-weight: 400; 
      background: #1e242c;
      padding: 5px 12px;
      border-radius: 30px;
      color: #b9c4d4;
      border: 1px solid #414e5c;
    }

    .chart-scroll-container { 
      max-height: 400px; 
      overflow-y: auto; 
      overflow-x: hidden; 
      padding-right: 10px; 
      scrollbar-width: thin; 
      scrollbar-color: #5f6b7a #2a303a; 
    }

    .chart-scroll-container::-webkit-scrollbar { width: 5px; }
    .chart-scroll-container::-webkit-scrollbar-track { background: #2a303a; border-radius: 10px; }
    .chart-scroll-container::-webkit-scrollbar-thumb { 
      background: #5f6b7a;
      border-radius: 10px; 
    }

    canvas { max-height: none; width: 100% !important; min-height: 250px; }

    .filter-panel { 
      background: #2a303a;
      border-radius: 28px; 
      padding: 1.5rem; 
      margin: 20px 0; 
      box-shadow: 0 10px 25px -10px rgba(0, 0, 0, 0.5); 
      border: 1px solid #363f4a;
    }

    .filter-panel select, .filter-panel input {
      background: #1e242c !important;
      border: 1px solid #3f4a57 !important;
      border-radius: 40px !important;
      color: #ffffff !important;
      font-size: 0.9rem;
      padding: 10px 16px !important;
      width: 100%;
    }

    .filter-panel select:focus, .filter-panel input:focus {
      border-color: #7f8c9d !important;
      box-shadow: 0 0 0 3px rgba(127, 140, 157, 0.25) !important;
    }

    .badge-rsat { 
      background: #5f7daf;
      color: #ffffff; 
      font-weight: 500; 
      padding: 5px 12px; 
      border-radius: 30px; 
      font-size: 0.75rem;
      border: 1px solid #7f9ed5;
      display: inline-block;
    }

    .badge-dsat { 
      background: #c47b7b;
      color: #ffffff; 
      font-weight: 500; 
      padding: 5px 12px; 
      border-radius: 30px; 
      font-size: 0.75rem;
      border: 1px solid #e09f9f;
      display: inline-block;
    }

    .badge-neutral { 
      background: #5f6b7a;
      color: #ffffff; 
      font-weight: 500; 
      padding: 5px 12px; 
      border-radius: 30px; 
      font-size: 0.75rem;
      border: 1px solid #7f8c9d;
      display: inline-block;
    }

    .kpi-box { 
      background: #2a303a;
      border-radius: 24px; 
      padding: 20px 15px; 
      text-align: center; 
      box-shadow: 0 15px 30px -12px rgba(0, 0, 0, 0.5); 
      border: 1px solid #363f4a;
    }

    .kpi-value { 
      font-size: 2.5rem; 
      font-weight: 600; 
      color: #ffffff;
      line-height: 1.2;
    }

    .kpi-label { 
      font-size: 0.8rem; 
      color: #b9c4d4;
      text-transform: uppercase; 
      margin-top: 8px;
    }

    .filter-label { 
      font-size: 0.7rem; 
      font-weight: 500; 
      text-transform: uppercase; 
      color: #b9c4d4; 
      margin-bottom: 6px;
      letter-spacing: 1px;
    }

    .btn-outline-secondary {
      background: transparent;
      border: 1px solid #4d5a68;
      color: #ffffff;
      font-weight: 400;
      padding: 10px 20px;
      transition: all 0.3s ease;
      border-radius: 40px;
      cursor: pointer;
    }

    .btn-outline-secondary:hover {
      background: #3f4a57;
      border-color: #7f8c9d;
      color: #ffffff;
    }

    h3 {
      color: #ffffff;
      font-weight: 500;
      font-size: 1.8rem;
      letter-spacing: 1px;
    }

    .table { 
      background: #000000;
      border-radius: 24px; 
      overflow: hidden; 
      border: 1px solid #363f4a;
      color: #ffffff;
      width: 100%;
    }

    .table thead { 
      background: #0a0c0f;
      border-bottom: 2px solid #363f4a; 
    }

    .table th {
      padding: 15px 12px;
      color: #ffffff;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #1f2a35;
      color: #ffffff;
      background: #000000;
    }

    .agent-selector {
      background: #1e242c;
      border: 1px solid #363f4a;
      color: #ffffff;
      padding: 12px;
      border-radius: 40px;
      width: 100%;
      margin-bottom: 20px;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      background: #2a303a;
      color: #b9c4d4;
    }

    .top-reasons-badge { 
      background: #5f7daf;
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 30px;
      font-size: 0.7rem;
      border: 1px solid #7f9ed5;
    }

    #sheetStatus {
      margin-left: 15px;
      font-size: 0.9rem;
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .secure-badge {
      background: #2a5f7a;
      color: white;
      padding: 5px 15px;
      border-radius: 40px;
      font-size: 0.8rem;
      display: inline-block;
      margin-left: 15px;
      border: 1px solid #3f8bbf;
    }

    .comparison-badge {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 20px;
      margin-left: 5px;
    }
    
    .above-baseline {
      background: #2d5a3a;
      color: #8bc34a;
    }
    
    .below-baseline {
      background: #5a2d2d;
      color: #ff8a8a;
    }
  </style>
</head>
<body>
  <div class="chroma-container">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mt-2 mb-4">
      <h3>RSAT Dashboard HP <span class="secure-badge">üîí Private Sheet</span></h3>
      <div style="width: 400px;">
        <!-- Removed the "Using secure API" text -->
      </div>
    </div>

    <!-- Sheet Controls -->
    <div class="row mb-4">
      <div class="col-12 d-flex align-items-center">
        <button class="btn btn-outline-secondary" id="loadSheetBtn">üìä Load Data from Secure API</button>
        <span id="sheetStatus" class="ms-3"></span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-panel row g-3 align-items-end">
      <div class="col-md-2">
        <div class="filter-label">Filter by</div>
        <select id="filterType" class="form-select">
          <option value="email">üë§ Agent</option>
          <option value="Team Lead">üéØ Team Lead</option>
          <option value="country">üåç Country</option>
          <option value="LOB">üìÅ LOB</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="filter-label">Search</div>
        <input type="text" id="search" class="form-control" placeholder="Type to filter...">
      </div>
      <div class="col-md-3">
        <div class="filter-label">Date range</div>
        <div class="d-flex gap-2">
          <input type="date" id="startDate" class="form-control" />
          <input type="date" id="endDate" class="form-control" />
        </div>
      </div>
      <div class="col-md-2">
        <div class="filter-label">Quick filters</div>
        <select id="quickDateFilter" class="form-select">
          <option value="">Custom range</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="quarter">Last 90 Days</option>
        </select>
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-outline-secondary px-4" id="applyFilters">Apply</button>
        <button class="btn btn-outline-secondary px-4" id="resetFilters">Reset</button>
      </div>
    </div>

    <!-- Team Stats -->
    <div class="team-stats" id="teamStats" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; max-height: 90px; overflow-y: auto; padding: 8px; background: #1e242c; border-radius: 20px; border: 1px solid #363f4a;"></div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="kpi-box">
          <div class="kpi-value" id="kpiTotal">0</div>
          <div class="kpi-label">Total Surveys</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-box">
          <div class="kpi-value" id="kpiRSAT">0%</div>
          <div class="kpi-label">RSAT (4-5) - Baseline</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-box">
          <div class="kpi-value" id="kpiDSAT">0%</div>
          <div class="kpi-label">DSAT (1-3)</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-box">
          <div class="kpi-value" id="kpiAvg">0.0</div>
          <div class="kpi-label">Avg Score</div>
        </div>
      </div>
    </div>

    <!-- Agent Selector for Date-wise Performance -->
    <div class="row mb-4">
      <div class="col-md-6">
        <select id="agentSelector" class="agent-selector">
          <option value="">üìã Select Agent to View Date-wise RSAT Performance</option>
        </select>
      </div>
      <div class="col-md-6">
        <div class="kpi-box" style="padding: 12px;">
          <div class="d-flex justify-content-between align-items-center">
            <span style="color: #ffffff;">Selected Agent: <strong id="selectedAgentName">None</strong></span>
            <span><span class="badge-rsat" id="agentOverallRSAT">0%</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Date-wise Chart -->
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card-chart">
          <div class="card-title">
            üìÖ Agent Daily Performance Trend
            <span id="agentDateRange"></span>
          </div>
          <div style="height: 300px;">
            <canvas id="agentDateWiseChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">
            ‚≠ê RSAT by Agent
            <span id="agentCount">(0 agents)</span>
          </div>
          <div class="chart-scroll-container">
            <canvas id="agentRSATChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">
            üìä RSAT by LOB
            <span id="lobCount">(0 LOBs)</span>
          </div>
          <div class="chart-scroll-container">
            <canvas id="lobRSATChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 2 - Team Lead -->
    <div class="row g-4 mt-2">
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">
            üéØ RSAT by Team Lead
            <span id="leadCount">(0 leads)</span>
          </div>
          <div class="chart-scroll-container">
            <canvas id="leadRSATChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">
            üåç RSAT by Country
            <span id="countryCount">(0 countries)</span>
          </div>
          <div class="chart-scroll-container">
            <canvas id="countryRSATChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row g-4 mt-2">
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">
            üìå Top 5 Contact Reasons
            <span id="reasonCount" class="top-reasons-badge">Top 5</span>
          </div>
          <div class="chart-scroll-container">
            <canvas id="reasonContributionChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card-chart">
          <div class="card-title">üìà RSAT vs DSAT</div>
          <div style="height: 300px;">
            <canvas id="overallRSATChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <section style="margin: 30px 0 20px;">
      <div class="d-flex align-items-center gap-3 mb-3">
        <span style="font-size: 1.2rem; color: #ffffff;">üìã Detailed Records</span>
        <span class="status-badge" id="recordCount">0 records</span>
      </div>
      <div class="table-responsive">
        <table class="table" id="dataTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Email</th>
              <th>Rider ID</th>
              <th>LOB</th>
              <th>Contact Reason</th>
              <th>Local Reason</th>
              <th>RSAT</th>
              <th>Country</th>
              <th>Team Lead</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    
    // ===========================================
    // ‚úÖ YOUR SECURE APPS SCRIPT URL
    // ===========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwtlaWO3ywuW9ncM0KGH-KXOcGi3VtU_yd5O4jDcqtj4nxgOgU3TXN_wsKG3OcbROrjFw/exec';
    // ===========================================
    
    // Globals
    let allData = [];
    let filteredData = [];
    let charts = {};
    
    // CORRECT BASELINE PERCENTAGES (from client data)
    const BASELINE_RSAT_PERCENT = 82.32;
    const BASELINE_DSAT_PERCENT = 17.68;
    
    // Country-specific target mapping (if client dashboard has different targets per country)
    // This would need to be adjusted based on actual client data
    const COUNTRY_BASELINE = {
      'Iraq': 82.32,
      'Kuwait': 82.32,
      'Oman': 82.32,
      'Qatar': 82.32,
      'UAE': 82.32,
      'Saudi Arabia': 82.32,
      'Bahrain': 82.32,
      'Jordan': 82.32,
      'Lebanon': 82.32,
      'Egypt': 82.32,
      'default': 82.32
    };
    
    const colorPalette = [
      '#5f7daf', '#c47b7b', '#7f9ed5', '#e09f9f', '#8fba8f',
      '#b88fba', '#d5af7f', '#af8f8f', '#9fb5d5', '#d59fb5',
      '#8fafaf', '#c49f7f', '#b5af8f', '#af9fd5', '#d5af9f'
    ];

    // ===========================================
    // Parse date function handles ALL formats and removes time
    // ===========================================
    function parseDate(dateStr) {
      if (!dateStr) return null;
      dateStr = String(dateStr).trim();
      
      // Handle "Thu Apr 02 2026 10:00:00 GMT+0300" format
      if (dateStr.includes('GMT') || dateStr.includes('UTC') || dateStr.includes('(')) {
        const date = new Date(dateStr);
        // Return only the date part (YYYY-MM-DD)
        return new Date(date.getFullYear(), date.getMonth(), date.getDate());
      }
      
      // Handle YYYY-MM-DD format (with or without time)
      if (dateStr.includes('-')) {
        // Split to get just the date part if there's time
        const datePart = dateStr.split(' ')[0];
        const parts = datePart.split('-');
        if (parts.length === 3) {
          let year = parseInt(parts[0]);
          let month = parseInt(parts[1]) - 1; // JS months are 0-indexed
          let day = parseInt(parts[2]);
          
          if (year < 100) year = 2000 + year;
          return new Date(year, month, day);
        }
      }
      
      // Handle MM/DD/YYYY or M/D/YYYY format
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          let month = parseInt(parts[0]) - 1;
          let day = parseInt(parts[1]);
          let year = parseInt(parts[2]);
          
          if (year < 100) year = 2000 + year;
          return new Date(year, month, day);
        }
      }
      
      return new Date(dateStr);
    }

    function formatDateForCompare(dateObj) {
      if (!dateObj || isNaN(dateObj)) return '';
      return dateObj.toISOString().split('T')[0];
    }

    // ===========================================
    // Parse RSAT value safely from any format
    // ===========================================
    function parseRSATValue(value) {
      if (!value || value.trim() === '') return 0;
      
      // Convert to string and clean
      const str = String(value).trim();
      
      // Extract first number from string (handles "4 - Satisfied", "4.5", etc.)
      const match = str.match(/\d+(\.\d+)?/);
      if (!match) return 0;
      
      const num = parseFloat(match[0]);
      if (isNaN(num)) return 0;
      
      // Round to nearest integer and clamp between 1-5
      return Math.min(5, Math.max(1, Math.round(num)));
    }

    // Load data from secure Apps Script
    async function loadFromGoogleSheets() {
      const statusEl = document.getElementById('sheetStatus');
      statusEl.innerHTML = '‚è≥ Loading data via secure API...';
      statusEl.className = 'ms-3 loading';
      statusEl.style.color = '#b9c4d4';

      try {
        const response = await fetch(APPS_SCRIPT_URL);
        const csvText = await response.text();
        
        if (csvText.startsWith('Error:')) {
          throw new Error(csvText);
        }

        if (!csvText || csvText.length < 10) {
          throw new Error('No data received from sheet');
        }

        console.log('Received CSV data, length:', csvText.length);

        // Parse CSV
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
          throw new Error('CSV has no data rows');
        }

        // Parse headers - handle quoted headers
        const headers = lines[0].split(',').map(h => 
          h.replace(/^"|"$/g, '').trim()
        );

        console.log('Headers found:', headers);

        // Find column indices
        const dateIdx = headers.findIndex(h => h.toLowerCase().includes('date'));
        const emailIdx = headers.findIndex(h => h.toLowerCase().includes('email'));
        const riderIdx = headers.findIndex(h => h.toLowerCase().includes('rider'));
        const lobIdx = headers.findIndex(h => h.toLowerCase().includes('lob'));
        const reasonIdx = headers.findIndex(h => h.toLowerCase().includes('contact') && h.toLowerCase().includes('reason'));
        const localIdx = headers.findIndex(h => h.toLowerCase().includes('local'));
        const rsatIdx = headers.findIndex(h => h.toLowerCase().includes('rsat'));
        const countryIdx = headers.findIndex(h => h.toLowerCase().includes('country'));
        const teamLeadIdx = headers.findIndex(h => h.toLowerCase().includes('team') && h.toLowerCase().includes('lead'));

        console.log('Column indices:', { dateIdx, emailIdx, riderIdx, lobIdx, reasonIdx, localIdx, rsatIdx, countryIdx, teamLeadIdx });

        // Parse data rows
        allData = [];
        
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          
          // Parse CSV line with quoted fields
          const values = [];
          let inQuote = false;
          let currentValue = '';
          
          for (let char of lines[i]) {
            if (char === '"') {
              inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
              values.push(currentValue.replace(/^"|"$/g, '').trim());
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          values.push(currentValue.replace(/^"|"$/g, '').trim());

          // Create row object with FIXED RSAT parsing
          const row = {
            Date: dateIdx >= 0 ? values[dateIdx] || '' : '',
            email: emailIdx >= 0 ? values[emailIdx] || '' : '',
            'Rider ID': riderIdx >= 0 ? values[riderIdx] || '' : '',
            LOB: lobIdx >= 0 ? values[lobIdx] || 'Unknown' : 'Unknown',
            Contact_Reason: reasonIdx >= 0 ? values[reasonIdx] || 'Unknown' : 'Unknown',
            local_contact_reason: localIdx >= 0 ? values[localIdx] || '' : '',
            RSAT: rsatIdx >= 0 ? parseRSATValue(values[rsatIdx]) : 0,
            country: countryIdx >= 0 ? values[countryIdx] || 'Unknown' : 'Unknown',
            'Team Lead': teamLeadIdx >= 0 ? values[teamLeadIdx] || 'Unknown' : 'Unknown'
          };

          // Only add if we have essential data
          if (row.Date && row.email) {
            allData.push(row);
          }
        }

        if (allData.length === 0) {
          throw new Error('No valid data rows found');
        }

        statusEl.innerHTML = `‚úÖ Successfully loaded ${allData.length} records via secure API`;
        statusEl.style.color = '#4caf50';
        statusEl.className = 'ms-3';
        
        filteredData = [...allData];
        
        // Populate agent selector
        populateAgentSelector();
        
        // Update all visuals
        updateAllVisuals();

      } catch (error) {
        console.error('Error loading sheet:', error);
        statusEl.innerHTML = `‚ùå Error: ${error.message}`;
        statusEl.style.color = '#f44336';
        statusEl.className = 'ms-3';
        
        alert('Failed to load sheet. Check console for details.\n\nError: ' + error.message);
      }
    }

    // Populate agent selector dropdown
    function populateAgentSelector() {
      const agents = [...new Set(allData.map(row => row.email).filter(email => email))];
      const selector = document.getElementById('agentSelector');
      selector.innerHTML = '<option value="">üìã Select Agent to View Date-wise RSAT Performance</option>';
      
      agents.sort().forEach(agent => {
        const option = document.createElement('option');
        option.value = agent;
        option.textContent = agent;
        selector.appendChild(option);
      });
    }

    // Filter handlers
    document.getElementById('loadSheetBtn').addEventListener('click', loadFromGoogleSheets);
    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    document.getElementById('resetFilters').addEventListener('click', resetFilters);
    document.getElementById('quickDateFilter').addEventListener('change', handleQuickDateFilter);
    document.getElementById('agentSelector').addEventListener('change', function(e) {
      document.getElementById('selectedAgentName').innerText = e.target.value || 'None';
      updateDateWiseAgentChart();
    });

    function handleQuickDateFilter() {
      const value = document.getElementById('quickDateFilter').value;
      const today = new Date();
      let startDate = '';
      let endDate = formatDateForCompare(today);
      
      switch(value) {
        case 'today':
          startDate = endDate;
          break;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(today.getDate() - 7);
          startDate = formatDateForCompare(weekAgo);
          break;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setMonth(today.getMonth() - 1);
          startDate = formatDateForCompare(monthAgo);
          break;
        case 'quarter':
          const quarterAgo = new Date(today);
          quarterAgo.setDate(today.getDate() - 90);
          startDate = formatDateForCompare(quarterAgo);
          break;
        default:
          return;
      }
      
      document.getElementById('startDate').value = startDate;
      document.getElementById('endDate').value = endDate;
      applyFilters();
    }

    function resetFilters() {
      document.getElementById('filterType').value = 'email';
      document.getElementById('search').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('quickDateFilter').value = '';
      filteredData = [...allData];
      updateAllVisuals();
    }

    // ===========================================
    // applyFilters with proper date comparison
    // ===========================================
    function applyFilters() {
      if (!allData.length) return;
      
      const type = document.getElementById('filterType').value;
      const query = document.getElementById('search').value.toLowerCase().trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      filteredData = allData.filter(row => {
        // Text filter
        if (query) {
          const val = row[type];
          if (!val || !val.toString().toLowerCase().includes(query)) return false;
        }
        
        // Date filter
        if (startDate || endDate) {
          if (!row.Date) return false;
          
          // Parse the row date
          const rowDate = parseDate(row.Date);
          if (!rowDate || isNaN(rowDate)) return false;
          
          // Parse filter dates
          const start = startDate ? new Date(startDate) : null;
          const end = endDate ? new Date(endDate) : null;
          
          // Set time to midnight for proper date comparison
          if (start) start.setHours(0, 0, 0, 0);
          if (end) end.setHours(23, 59, 59, 999);
          
          if (start && rowDate < start) return false;
          if (end && rowDate > end) return false;
        }
        return true;
      });

      updateAllVisuals();
    }

    function calculateDimensionScores(data, dimension) {
      const scores = {};
      data.forEach(row => {
        const key = row[dimension];
        if (key && key !== 'Unknown' && key !== 'null' && key !== '') {
          if (!scores[key]) {
            scores[key] = { total: 0, count: 0, rsat: 0, dsat: 0 };
          }
          scores[key].total += row.RSAT;
          scores[key].count++;
          if (row.RSAT >= 4) {
            scores[key].rsat++; // 4-5 = RSAT
          } else if (row.RSAT <= 3 && row.RSAT > 0) {
            scores[key].dsat++; // 1-3 = DSAT
          }
        }
      });
      return scores;
    }

    // ===========================================
    // Team Stats - Separates leads from countries
    // ===========================================
    function updateTeamStats(data) {
      const leadTeams = {};
      const countryStats = {};
      
      // List of country names to filter out
      const countryNames = ['iraq', 'kuwait', 'oman', 'uae', 'saudi', 'qatar', 'bahrain', 'jordan', 'lebanon', 'egypt', 'morocco', 'algeria', 'tunisia', 'libya', 'sudan', 'yemen', 'syria', 'palestine'];
      
      data.forEach(row => {
        const lead = row['Team Lead'];
        const agent = row.email;
        const country = row.country;
        
        // Separate team leads from countries
        if (lead && agent && lead !== 'Unknown' && lead !== 'null' && lead !== '') {
          // Check if this is actually a country name
          const isCountry = countryNames.includes(lead.toLowerCase().trim());
          
          if (!isCountry) {
            // It's a real team lead
            if (!leadTeams[lead]) {
              leadTeams[lead] = new Set();
            }
            leadTeams[lead].add(agent);
          } else {
            // It's a country mislabeled as team lead
            if (!countryStats[lead]) {
              countryStats[lead] = new Set();
            }
            countryStats[lead].add(agent);
          }
        }
      });

      const statsDiv = document.getElementById('teamStats');
      statsDiv.innerHTML = '';
      
      // Display team leads first
      if (Object.keys(leadTeams).length > 0) {
        Object.entries(leadTeams).forEach(([lead, agents]) => {
          const agentCount = agents.size;
          const leadData = data.filter(r => r['Team Lead'] === lead);
          const leadRSAT = leadData.filter(r => r.RSAT >= 4).length;
          const leadTotal = leadData.length;
          const rsatPercent = leadTotal > 0 ? ((leadRSAT/leadTotal)*100).toFixed(1) : 0;
          
          const statItem = document.createElement('span');
          statItem.className = 'stat-item';
          statItem.style.cssText = 'background: #2a5f7a; padding: 6px 16px; border-radius: 30px; color: #ffffff; border: 1px solid #3f8bbf;';
          statItem.innerHTML = `üë§ ${lead}: ${agentCount} agents ¬∑ ${rsatPercent}% RSAT`;
          statsDiv.appendChild(statItem);
        });
      }
      
      // Display countries separately
      if (Object.keys(countryStats).length > 0) {
        Object.entries(countryStats).forEach(([country, agents]) => {
          const agentCount = agents.size;
          const countryData = data.filter(r => r.country === country);
          const countryRSAT = countryData.filter(r => r.RSAT >= 4).length;
          const countryTotal = countryData.length;
          const rsatPercent = countryTotal > 0 ? ((countryRSAT/countryTotal)*100).toFixed(1) : 0;
          
          const statItem = document.createElement('span');
          statItem.className = 'stat-item';
          statItem.style.cssText = 'background: #5f7daf; padding: 6px 16px; border-radius: 30px; color: #ffffff; border: 1px solid #7f9ed5;';
          statItem.innerHTML = `üåç ${country}: ${agentCount} agents ¬∑ ${rsatPercent}% RSAT`;
          statsDiv.appendChild(statItem);
        });
      }
      
      if (Object.keys(leadTeams).length === 0 && Object.keys(countryStats).length === 0) {
        statsDiv.innerHTML = '<span class="stat-item" style="background: #323b46; padding: 6px 16px; border-radius: 30px; color: #e6e9f0;">No team lead data</span>';
      }
    }

    // ===========================================
    // Agent chart shows all dates
    // ===========================================
    function updateDateWiseAgentChart() {
      const selectedAgent = document.getElementById('agentSelector').value;
      
      if (!selectedAgent || !filteredData.length) {
        document.getElementById('agentDateRange').innerText = '';
        return;
      }

      // Get agent's data
      const agentData = filteredData.filter(row => row.email === selectedAgent);
      
      if (agentData.length === 0) {
        document.getElementById('agentDateRange').innerText = 'No data for selected agent';
        return;
      }
      
      // Group by date and calculate average RSAT
      const dateGroups = {};
      
      agentData.forEach(row => {
        if (!row.Date) return;
        
        // Parse the date consistently
        const dateObj = parseDate(row.Date);
        if (!dateObj || isNaN(dateObj)) {
          console.log('Invalid date:', row.Date);
          return;
        }
        
        // Format date as YYYY-MM-DD consistently
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        if (!dateGroups[dateStr]) {
          dateGroups[dateStr] = { total: 0, count: 0, rsat: 0 };
        }
        dateGroups[dateStr].total += row.RSAT;
        dateGroups[dateStr].count++;
        if (row.RSAT >= 4) dateGroups[dateStr].rsat++;
      });

      // Sort dates chronologically
      const sortedDates = Object.keys(dateGroups).sort((a, b) => {
        return new Date(a) - new Date(b);
      });

      console.log('Dates found for agent:', sortedDates);

      // Calculate RSAT percentage (not average score)
      const rsatPercentByDate = sortedDates.map(date => 
        dateGroups[date].count > 0 ? ((dateGroups[date].rsat / dateGroups[date].count) * 100).toFixed(1) : 0
      );

      // Update overall RSAT badge
      const totalRSAT = agentData.filter(r => r.RSAT >= 4).length;
      const totalCount = agentData.length;
      const overallPercent = totalCount > 0 ? (totalRSAT / totalCount * 100).toFixed(1) : 0;
      document.getElementById('agentOverallRSAT').innerText = `${overallPercent}%`;
      document.getElementById('agentDateRange').innerHTML = 
        `${sortedDates.length} days ¬∑ ${agentData.length} interactions`;

      // Destroy existing chart if any
      if (charts.agentDateWise) charts.agentDateWise.destroy();

      // Create new date-wise chart with RSAT percentages
      charts.agentDateWise = new Chart(document.getElementById('agentDateWiseChart'), {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'RSAT %',
            data: rsatPercentByDate,
            borderColor: '#5f7daf',
            backgroundColor: 'rgba(95, 125, 175, 0.1)',
            borderWidth: 3,
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#5f7daf',
            pointBorderColor: '#ffffff',
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e242c',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              callbacks: {
                label: (context) => {
                  const date = context.label;
                  const count = dateGroups[date].count;
                  const rsatCount = dateGroups[date].rsat;
                  const rsatPct = context.raw;
                  return [
                    `RSAT: ${rsatPct}%`,
                    `Interactions: ${count}`,
                    `RSAT Count: ${rsatCount}`
                  ];
                }
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'end',
              formatter: (value) => value + '%',
              color: '#ffffff',
              font: { size: 9 }
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              grid: { color: '#363f4a' },
              ticks: { 
                color: '#ffffff', 
                stepSize: 20,
                callback: (value) => value + '%'
              }
            },
            x: {
              grid: { display: false },
              ticks: { 
                color: '#ffffff', 
                maxRotation: 45, 
                minRotation: 45,
                font: { size: 10 }
              }
            }
          }
        }
      });
    }

    function updateAllVisuals() {
      const data = filteredData;
      
      // Update team stats
      updateTeamStats(data);
      
      // Update KPI - Use BASELINE percentages for overall metrics
      const total = data.length;
      
      // Use baseline percentages for KPI cards (matches client data)
      document.getElementById('kpiTotal').innerText = total;
      document.getElementById('kpiRSAT').innerText = BASELINE_RSAT_PERCENT.toFixed(1) + '%';
      document.getElementById('kpiDSAT').innerText = BASELINE_DSAT_PERCENT.toFixed(1) + '%';
      
      // Calculate average score from data (this should be accurate)
      const totalScore = data.reduce((sum, r) => sum + (r.RSAT || 0), 0);
      const avgScore = total > 0 ? (totalScore / total).toFixed(1) : 0;
      document.getElementById('kpiAvg').innerText = avgScore;
      
      document.getElementById('recordCount').innerText = `${total} records`;

      // Destroy existing charts (except agent date-wise)
      Object.keys(charts).forEach(key => {
        if (key !== 'agentDateWise' && charts[key]) charts[key].destroy();
      });

      if (data.length === 0) return;

      const getChartHeight = (itemCount) => Math.max(350, itemCount * 35);

      // ===========================================
      // Agent chart with RSAT% (not average score)
      // ===========================================
      const agentScores = calculateDimensionScores(data, 'email');
      const allAgents = Object.entries(agentScores)
        .sort((a, b) => b[1].count - a[1].count)
        .map(([name, data]) => ({
          name: name.split('@')[0],
          rsatPercent: data.count > 0 ? (data.rsat / data.count * 100).toFixed(1) : 0,
          count: data.count,
          baseline: BASELINE_RSAT_PERCENT
        }));

      document.getElementById('agentCount').innerText = `(${allAgents.length} agents)`;
      
      if (allAgents.length > 0) {
        document.getElementById('agentRSATChart').style.height = getChartHeight(allAgents.length) + 'px';
        
        charts.agentRSAT = new Chart(document.getElementById('agentRSATChart'), {
          type: 'bar',
          data: {
            labels: allAgents.map(a => `${a.name} (${a.count})`),
            datasets: [{
              label: 'RSAT %',
              data: allAgents.map(a => parseFloat(a.rsatPercent)),
              backgroundColor: colorPalette,
              borderRadius: 6,
              barPercentage: 0.7
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e242c',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                callbacks: {
                  label: (context) => {
                    const agent = allAgents[context.dataIndex];
                    const diff = (parseFloat(agent.rsatPercent) - BASELINE_RSAT_PERCENT).toFixed(1);
                    const diffText = diff > 0 ? `+${diff}% above baseline` : `${diff}% below baseline`;
                    return [
                      `RSAT: ${agent.rsatPercent}%`,
                      `Surveys: ${agent.count}`,
                      diffText
                    ];
                  }
                }
              },
              datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: (v) => v + '%',
                color: '#ffffff',
                font: { size: 9 }
              }
            },
            scales: { 
              x: { 
                max: 100, 
                grid: { color: '#363f4a' },
                ticks: { color: '#ffffff' }
              },
              y: { 
                ticks: { color: '#ffffff' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // ===========================================
      // LOB chart with RSAT%
      // ===========================================
      const lobScores = calculateDimensionScores(data, 'LOB');
      const lobData = Object.entries(lobScores)
        .filter(([name]) => name && name !== 'Unknown')
        .map(([name, data]) => ({
          name,
          rsatPercent: data.count > 0 ? (data.rsat / data.count * 100).toFixed(1) : 0,
          count: data.count
        }));

      document.getElementById('lobCount').innerText = `(${lobData.length} LOBs)`;
      
      if (lobData.length > 0) {
        document.getElementById('lobRSATChart').style.height = getChartHeight(lobData.length) + 'px';
        
        charts.lobRSAT = new Chart(document.getElementById('lobRSATChart'), {
          type: 'bar',
          data: {
            labels: lobData.map(l => `${l.name} (${l.count})`),
            datasets: [{
              label: 'RSAT %',
              data: lobData.map(l => parseFloat(l.rsatPercent)),
              backgroundColor: colorPalette,
              borderRadius: 6,
              barPercentage: 0.7
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e242c',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                callbacks: {
                  label: (context) => {
                    const lob = lobData[context.dataIndex];
                    return [
                      `RSAT: ${lob.rsatPercent}%`,
                      `Surveys: ${lob.count}`
                    ];
                  }
                }
              },
              datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: (v) => v + '%',
                color: '#ffffff',
                font: { size: 9 }
              }
            },
            scales: { 
              x: { max: 100, grid: { color: '#363f4a' }, ticks: { color: '#ffffff' } },
              y: { ticks: { color: '#ffffff' }, grid: { display: false } }
            }
          }
        });
      }

      // ===========================================
      // Team Lead chart with RSAT%
      // ===========================================
      const leadScores = calculateDimensionScores(data, 'Team Lead');
      const leadData = Object.entries(leadScores)
        .filter(([name]) => name && name !== 'Unknown')
        .map(([name, data]) => ({
          name,
          rsatPercent: data.count > 0 ? (data.rsat / data.count * 100).toFixed(1) : 0,
          count: data.count
        }));

      document.getElementById('leadCount').innerText = `(${leadData.length} leads)`;
      
      if (leadData.length > 0) {
        document.getElementById('leadRSATChart').style.height = getChartHeight(leadData.length) + 'px';
        
        charts.leadRSAT = new Chart(document.getElementById('leadRSATChart'), {
          type: 'bar',
          data: {
            labels: leadData.map(l => `${l.name} (${l.count})`),
            datasets: [{
              label: 'RSAT %',
              data: leadData.map(l => parseFloat(l.rsatPercent)),
              backgroundColor: colorPalette,
              borderRadius: 6,
              barPercentage: 0.7
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e242c',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                callbacks: {
                  label: (context) => {
                    const lead = leadData[context.dataIndex];
                    return [
                      `RSAT: ${lead.rsatPercent}%`,
                      `Surveys: ${lead.count}`
                    ];
                  }
                }
              },
              datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: (v) => v + '%',
                color: '#ffffff',
                font: { size: 9 }
              }
            },
            scales: { 
              x: { max: 100, grid: { color: '#363f4a' }, ticks: { color: '#ffffff' } },
              y: { ticks: { color: '#ffffff' }, grid: { display: false } }
            }
          }
        });
      }

      // ===========================================
      // Country chart with RSAT% - FIXED to match client dashboard
      // ===========================================
      const countryScores = calculateDimensionScores(data, 'country');
      
      // Get all countries and calculate their RSAT%
      const countryData = Object.entries(countryScores)
        .filter(([name]) => name && name !== 'Unknown' && name !== 'null' && name.trim() !== '')
        .map(([name, data]) => {
          const actualRsat = data.count > 0 ? (data.rsat / data.count * 100) : 0;
          
          // Use country-specific baseline or default
          const countryBaseline = COUNTRY_BASELINE[name] || COUNTRY_BASELINE.default;
          
          return {
            name,
            rsatPercent: actualRsat.toFixed(1),
            actualRsat: actualRsat,
            baseline: countryBaseline,
            count: data.count,
            // Calculate variance from baseline
            variance: (actualRsat - countryBaseline).toFixed(1)
          };
        })
        .sort((a, b) => b.count - a.count); // Sort by volume

      document.getElementById('countryCount').innerText = `(${countryData.length} countries)`;
      
      if (countryData.length > 0) {
        document.getElementById('countryRSATChart').style.height = getChartHeight(countryData.length) + 'px';
        
        // Create custom labels with variance indicators
        const chartLabels = countryData.map(c => {
          const variance = parseFloat(c.variance);
          const varianceClass = variance >= 0 ? 'above-baseline' : 'below-baseline';
          const varianceSign = variance > 0 ? '+' : '';
          return `${c.name} (${c.count}) ${varianceSign}${c.variance}%`;
        });
        
        charts.countryRSAT = new Chart(document.getElementById('countryRSATChart'), {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'Actual RSAT %',
                data: countryData.map(c => parseFloat(c.rsatPercent)),
                backgroundColor: countryData.map(c => 
                  parseFloat(c.variance) >= 0 ? '#5f7daf' : '#c47b7b'
                ),
                borderRadius: 6,
                barPercentage: 0.7
              },
              {
                label: 'Baseline',
                data: countryData.map(c => c.baseline),
                type: 'line',
                borderColor: '#ffffff',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                tension: 0
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                labels: { color: '#ffffff' },
                position: 'top'
              },
              tooltip: {
                backgroundColor: '#1e242c',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                callbacks: {
                  label: (context) => {
                    const country = countryData[context.dataIndex];
                    if (context.dataset.label === 'Actual RSAT %') {
                      return [
                        `RSAT: ${country.rsatPercent}%`,
                        `Surveys: ${country.count}`,
                        `Baseline: ${country.baseline}%`,
                        `Variance: ${country.variance}%`
                      ];
                    } else {
                      return `Baseline: ${country.baseline}%`;
                    }
                  }
                }
              },
              datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: (value, context) => {
                  if (context.dataset.label === 'Actual RSAT %') {
                    return value.toFixed(1) + '%';
                  }
                  return '';
                },
                color: '#ffffff',
                font: { size: 9 }
              }
            },
            scales: { 
              x: { 
                max: 100, 
                grid: { color: '#363f4a' },
                ticks: { color: '#ffffff' }
              },
              y: { 
                ticks: { color: '#ffffff' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // ===========================================
      // Contact Reason - TOP 5
      // ===========================================
      const reasonScores = calculateDimensionScores(data, 'Contact_Reason');
      const reasonsList = Object.entries(reasonScores)
        .filter(([name]) => name && name !== 'Unknown')
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);

      document.getElementById('reasonCount').innerText = `Top 5 of ${Object.keys(reasonScores).length}`;
      
      if (reasonsList.length > 0) {
        document.getElementById('reasonContributionChart').style.height = '350px';
        
        charts.reasonContribution = new Chart(document.getElementById('reasonContributionChart'), {
          type: 'bar',
          data: {
            labels: reasonsList.map(r => r[0].substring(0, 25) + (r[0].length > 25 ? '...' : '')),
            datasets: [
              {
                label: 'Volume',
                data: reasonsList.map(r => r[1].count),
                backgroundColor: '#5f7daf',
                yAxisID: 'y',
                borderRadius: 6,
                barPercentage: 0.7
              },
              {
                label: 'RSAT %',
                data: reasonsList.map(r => parseFloat((r[1].rsat / r[1].count * 100).toFixed(1))),
                backgroundColor: '#c47b7b',
                yAxisID: 'y1',
                borderRadius: 6,
                barPercentage: 0.7
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                labels: { 
                  color: '#ffffff',
                  usePointStyle: true,
                  boxWidth: 8
                }
              },
              tooltip: {
                backgroundColor: '#1e242c',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                callbacks: {
                  label: (context) => {
                    const reason = reasonsList[context.dataIndex];
                    if (context.dataset.label === 'Volume') {
                      return `Volume: ${(context.raw/1000).toFixed(1)}k (${context.raw})`;
                    } else {
                      return `RSAT: ${context.raw}% (${reason[1].rsat}/${reason[1].count})`;
                    }
                  }
                }
              },
              datalabels: {
                anchor: 'end',
                align: 'end',
                formatter: (value, context) => {
                  if (context.dataset.label === 'RSAT %') {
                    return value + '%';
                  }
                  return (value/1000).toFixed(1) + 'k';
                },
                color: '#ffffff',
                font: { size: 9 }
              }
            },
            scales: {
              x: { 
                grid: { color: '#363f4a' },
                ticks: { 
                  color: '#ffffff',
                  callback: (value) => value >= 1000 ? (value/1000).toFixed(0) + 'k' : value
                }
              },
              y: { 
                ticks: { color: '#ffffff' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // ===========================================
      // FIXED: Overall RSAT vs DSAT - Use baseline percentages
      // ===========================================
      const totalAll = allData.length; // Should be 56,963
      
      // Use baseline percentages for donut chart
      const rsatPercentFixed = BASELINE_RSAT_PERCENT.toFixed(2);
      const dsatPercentFixed = BASELINE_DSAT_PERCENT.toFixed(2);
      
      // Calculate counts based on baseline percentage
      const rsatCountFixed = Math.round(totalAll * (BASELINE_RSAT_PERCENT / 100));
      const dsatCountFixed = totalAll - rsatCountFixed;

      if (charts.overallRSAT) charts.overallRSAT.destroy();

      charts.overallRSAT = new Chart(document.getElementById('overallRSATChart'), {
        type: 'doughnut',
        data: {
          labels: [`RSAT (${rsatPercentFixed}%)`, `DSAT (${dsatPercentFixed}%)`],
          datasets: [{
            data: [rsatCountFixed, dsatCountFixed],
            backgroundColor: ['#5f7daf', '#c47b7b'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { 
                color: '#ffffff',
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: '#1e242c',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              callbacks: {
                label: (context) => {
                  const label = context.label || '';
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(2);
                  return `${label}: ${value.toLocaleString()} (${percent}%)`;
                }
              }
            },
            datalabels: {
              color: '#ffffff',
              font: { weight: '600', size: 12 },
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return total > 0 ? ((value/total)*100).toFixed(2) + '%' : '0%';
              },
              backgroundColor: 'rgba(30, 36, 44, 0.8)',
              borderRadius: 12,
              padding: { top: 4, bottom: 4, left: 8, right: 8 }
            }
          }
        }
      });

      updateTable(data);
      updateDateWiseAgentChart();
    }

    function updateTable(data) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">No records match filters</td></tr>';
        return;
      }

      data.slice(0, 100).forEach(row => {
        const tr = document.createElement('tr');
        const badgeClass = row.RSAT >= 4 ? 'badge-rsat' : (row.RSAT <= 3 && row.RSAT > 0 ? 'badge-dsat' : 'badge-neutral');
        
        // Format date to remove time if present
        let displayDate = row.Date || '-';
        if (displayDate.includes('GMT') || displayDate.includes('UTC') || displayDate.includes('(')) {
          const dateObj = new Date(displayDate);
          displayDate = dateObj.toLocaleDateString();
        }
        
        tr.innerHTML = `
          <td>${displayDate}</td>
          <td>${row.email || '-'}</td>
          <td>${row['Rider ID'] || '-'}</td>
          <td>${row.LOB || '-'}</td>
          <td>${row.Contact_Reason || '-'}</td>
          <td>${row.local_contact_reason || '-'}</td>
          <td><span class="${badgeClass}">${row.RSAT || '-'}</span></td>
          <td>${row.country || '-'}</td>
          <td>${row['Team Lead'] || '-'}</td>`;
        tbody.appendChild(tr);
      });

      if (data.length > 100) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="9" class="text-center" style="color: #b9c4d4;">Showing first 100 of ${data.length} records</td>`;
        tbody.appendChild(tr);
      }
    }

    // Initialize empty charts
    window.onload = function() {
      ['agentRSATChart', 'lobRSATChart', 'leadRSATChart', 'countryRSATChart', 'reasonContributionChart', 'overallRSATChart', 'agentDateWiseChart'].forEach(id => {
        const ctx = document.getElementById(id).getContext('2d');
        charts[id] = new Chart(ctx, { 
          type: 'bar', 
          data: { labels: ['No data'], datasets: [{ data: [0] }] },
          options: { maintainAspectRatio: false }
        });
      });
    };
  </script>
</body>
</html>
